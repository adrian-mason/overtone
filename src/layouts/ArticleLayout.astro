---
import BaseLayout from "./BaseLayout.astro";
import type { CategoryConfig } from "../lib/categories";

interface Heading {
  readonly depth: number;
  readonly slug: string;
  readonly text: string;
}

interface Props {
  article: {
    id: string;
    body?: string;
    data: {
      title: string;
      description: string;
      date: Date;
      featured: boolean;
      tags: string[];
    };
  };
  category: CategoryConfig;
  headings?: Heading[];
}

const { article, category, headings = [] } = Astro.props;
const tocItems = headings.filter((h) => h.depth === 2 || h.depth === 3);
const { title, description, date, featured, tags } = article.data;

const formattedDate = date.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const wordCount = (article.body ?? "").split(/\s+/).filter(Boolean).length;
const readingMinutes = Math.max(1, Math.round(wordCount / 200));
---

<BaseLayout title={`${title} — Overtone`} description={description}>
  <div
    class="min-h-screen"
    style={`background-color: ${category.bgColor};`}
  >
    {/* Reading progress bar */}
    <div class="fixed left-0 top-0 z-50 h-1 w-full">
      <div
        id="reading-progress"
        class="h-full origin-left scale-x-0 transition-none"
        style={`background-color: ${category.iconColor};`}
      />
    </div>

    {/* Dot grid overlay */}
    <div class="dot-grid pointer-events-none fixed inset-0"></div>

    <article class="relative z-10 mx-auto max-w-4xl space-y-8 p-8">
      {/* Back link */}
      <a
        href={`/${category.slug}`}
        class="inline-flex items-center gap-2 text-xl hover:underline"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7" /><path d="M19 12H5" /></svg>
        Back to {category.title}
      </a>

      {/* Article header */}
      <div class="space-y-4">
        {/* Featured badge */}
        {featured && (
          <span
            class="neo-badge px-3 py-1"
            style={`background-color: ${category.featuredBg};`}
          >
            Featured
          </span>
        )}

        {/* Title */}
        <h1 class="text-5xl font-bold leading-tight md:text-7xl">
          {title}
        </h1>

        {/* Date + Reading time + Tags */}
        <div class="flex flex-wrap items-center gap-4 text-lg text-gray-500">
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4" /><path d="M16 2v4" /><rect width="18" height="18" x="3" y="4" rx="2" /><path d="M3 10h18" /></svg>
            <time datetime={date.toISOString()}>{formattedDate}</time>
          </div>
          <span class="text-gray-300">|</span>
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>
            <span>{readingMinutes} min read</span>
          </div>
          {tags.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {tags.map((tag) => (
                <a
                  href={`/tags/${tag}`}
                  class="neo-tag bg-white px-3 py-0.5 text-sm"
                >
                  {tag}
                </a>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Table of Contents — desktop sidebar */}
      {tocItems.length > 2 && (
        <nav
          id="toc"
          class="fixed top-24 hidden max-h-[70vh] w-56 overflow-y-auto text-sm xl:block"
          style="left: max(1rem, calc((100vw - 56rem) / 2 - 15rem));"
          aria-label="Table of Contents"
        >
          <p class="mb-3 text-xs font-bold uppercase tracking-widest text-gray-400">On this page</p>
          <ul class="space-y-1.5">
            {tocItems.map((h) => (
              <li style={h.depth === 3 ? "padding-left: 0.75rem;" : ""}>
                <a
                  href={`#${h.slug}`}
                  class="toc-link block text-gray-400 transition-colors hover:text-black"
                  data-slug={h.slug}
                >
                  {h.text}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      )}

      {/* Article body — neo-brutalist card */}
      <div class="relative">
        <div class="absolute inset-0 rounded-lg border-2 border-black bg-white" style="transform: rotate(0.5deg);" />
        <div class="neo-card-sm relative p-8 md:p-12">
          <div class="prose">
            <slot />
          </div>
        </div>
      </div>

      {/* Footer — back to category */}
      <div class="flex justify-center pt-4">
        <a href={`/${category.slug}`} class="group relative">
          <div class="absolute inset-0 rounded-full border-2 border-black bg-white transition-transform group-hover:translate-x-1 group-hover:translate-y-1" />
          <div class="neo-pill relative flex items-center gap-3 px-8 py-4 text-xl font-bold">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7" /><path d="M19 12H5" /></svg>
            <span>More {category.title}</span>
          </div>
        </a>
      </div>
    </article>

    {/* Back to top button */}
    <button
      id="back-to-top"
      class="fixed bottom-8 right-8 z-50 hidden h-12 w-12 items-center justify-center rounded-full border-2 border-black bg-white shadow-[3px_3px_0_0_black] transition-all hover:-translate-y-0.5 hover:shadow-[4px_4px_0_0_black] active:translate-y-0 active:shadow-[1px_1px_0_0_black]"
      aria-label="Back to top"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6" /></svg>
    </button>
  </div>
</BaseLayout>

<style is:global>
  .prose {
    font-family: "Merriweather", serif;
    font-size: 1.0625rem;
    line-height: 1.8;
    color: #374151;
  }

  .prose :where(h2),
  .prose :where(h3) {
    position: relative;
  }

  .prose :where(h2) .heading-anchor,
  .prose :where(h3) .heading-anchor {
    position: absolute;
    left: -1.5em;
    top: 0;
    color: #d1d5db;
    text-decoration: none;
    font-weight: 400;
    opacity: 0;
    transition: opacity 0.15s ease;
  }

  .prose :where(h2):hover .heading-anchor,
  .prose :where(h3):hover .heading-anchor {
    opacity: 1;
    color: #9ca3af;
  }

  .prose :where(h2) {
    font-family: "Architects Daughter", sans-serif;
    font-weight: 700;
    font-size: 1.75rem;
    margin-top: 2em;
    margin-bottom: 0.75em;
    color: #111827;
  }

  .prose :where(h3) {
    font-family: "Architects Daughter", sans-serif;
    font-weight: 700;
    font-size: 1.375rem;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    color: #111827;
  }

  .prose :where(p) {
    margin-top: 0;
    margin-bottom: 1.25em;
  }

  .prose :where(a) {
    color: #3b82f6;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .prose :where(strong) {
    font-weight: 700;
    color: #111827;
  }

  .prose :where(ul) {
    list-style: disc;
    padding-left: 1.5em;
    margin-bottom: 1.25em;
  }

  .prose :where(ol) {
    list-style: decimal;
    padding-left: 1.5em;
    margin-bottom: 1.25em;
  }

  .prose :where(li) {
    margin-bottom: 0.375em;
  }

  .prose :where(blockquote) {
    border-left: 3px solid black;
    padding-left: 1em;
    font-style: italic;
    color: #6b7280;
    margin-top: 1.25em;
    margin-bottom: 1.25em;
  }

  .prose :where(code) {
    font-size: 0.875em;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    background-color: #f3f4f6;
    padding: 0.125em 0.375em;
    border-radius: 0.25rem;
    border: 1px solid #e5e7eb;
    color: #1f2937;
  }

  .prose :where(pre) {
    background-color: #f9fafb;
    border: 2px solid black;
    border-radius: 8px;
    padding: 1rem 1.25rem;
    overflow-x: auto;
    margin-top: 1.25em;
    margin-bottom: 1.25em;
  }

  .prose :where(pre code) {
    background-color: transparent;
    padding: 0;
    border-radius: 0;
    border: none;
    font-size: 0.8125rem;
    line-height: 1.7;
  }

  .prose :where(hr) {
    border-color: black;
    border-style: dashed;
    margin-top: 2em;
    margin-bottom: 2em;
  }

  .prose :where(img) {
    border: 2px solid black;
    border-radius: 8px;
    margin-top: 1.25em;
    margin-bottom: 1.25em;
  }
</style>

<script>
  const bar = document.getElementById("reading-progress");
  const topBtn = document.getElementById("back-to-top");

  window.addEventListener("scroll", () => {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;

    // Progress bar
    if (bar) {
      const progress = docHeight > 0 ? Math.min(scrollTop / docHeight, 1) : 0;
      bar.style.transform = `scaleX(${progress})`;
    }

    // Back to top visibility
    if (topBtn) {
      topBtn.style.display = scrollTop > window.innerHeight ? "flex" : "none";
    }
  }, { passive: true });

  topBtn?.addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // TOC active section tracking
  const tocLinks = document.querySelectorAll<HTMLAnchorElement>(".toc-link");
  if (tocLinks.length > 0) {
    const headings = Array.from(tocLinks).map((link) =>
      document.getElementById(link.dataset.slug ?? "")
    ).filter(Boolean) as HTMLElement[];

    const observer = new IntersectionObserver(
      (entries) => {
        for (const entry of entries) {
          const link = document.querySelector(`.toc-link[data-slug="${entry.target.id}"]`);
          if (!link) continue;
          if (entry.isIntersecting) {
            tocLinks.forEach((l) => { l.style.color = ""; l.style.fontWeight = ""; });
            link.setAttribute("style", "color: #111827; font-weight: 700;");
          }
        }
      },
      { rootMargin: "-80px 0px -70% 0px" }
    );

    headings.forEach((h) => observer.observe(h));
  }

  // Heading anchor links
  document.querySelectorAll(".prose h2[id], .prose h3[id]").forEach((heading) => {
    const anchor = document.createElement("a");
    anchor.href = `#${heading.id}`;
    anchor.className = "heading-anchor";
    anchor.setAttribute("aria-hidden", "true");
    anchor.textContent = "#";
    heading.prepend(anchor);
  });
</script>
