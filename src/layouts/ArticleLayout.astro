---
import BaseLayout from "./BaseLayout.astro";
import type { CategoryConfig } from "../lib/categories";
import type { BilingualContent, TocHeading } from "../lib/render-zh";

interface Heading {
  readonly depth: number;
  readonly slug: string;
  readonly text: string;
}

interface Props {
  article: {
    id: string;
    body?: string;
    data: {
      title: string;
      subtitle?: string;
      description: string;
      date: Date;
      featured: boolean;
      tags: string[];
    };
  };
  category: CategoryConfig;
  headings?: Heading[];
  bilingual?: BilingualContent;
}

const { article, category, headings = [], bilingual } = Astro.props;
const tocItems: TocHeading[] = bilingual
  ? bilingual.enHeadings
  : headings.filter((h) => h.depth === 2 || h.depth === 3);
const zhTocItems: TocHeading[] = bilingual ? bilingual.zhHeadings : [];
const { title, subtitle, description, date, featured, tags } = article.data;

const formattedDate = date.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const wordCount = (article.body ?? "").split(/\s+/).filter(Boolean).length;
const readingMinutes = Math.max(1, Math.round(wordCount / 200));
---

<BaseLayout title={`${title} — Overtone`} description={description}>
  <div
    class="min-h-screen"
    style={`background-color: ${category.bgColor};`}
  >
    {/* Reading progress bar */}
    <div class="fixed left-0 top-0 z-50 h-1 w-full">
      <div
        id="reading-progress"
        class="h-full origin-left scale-x-0 transition-none"
        style={`background-color: ${category.iconColor};`}
      />
    </div>

    <article class="relative z-10 mx-auto max-w-4xl space-y-8 p-8">
      {/* Back link */}
      <a
        href={`/${category.slug}`}
        class="inline-flex items-center gap-2 text-xl hover:underline"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7" /><path d="M19 12H5" /></svg>
        Back to {category.title}
      </a>

      {/* Article header */}
      <div class="space-y-4">
        {/* Featured badge */}
        {featured && (
          <span
            class="neo-badge px-3 py-1"
            style={`background-color: ${category.featuredBg};`}
          >
            Featured
          </span>
        )}

        {/* Title + Subtitle */}
        <h1 class="text-5xl font-bold leading-tight md:text-7xl">
          {title}
        </h1>
        {subtitle && (
          <p class="text-2xl text-gray-500 md:text-3xl">{subtitle}</p>
        )}

        {/* Date + Reading time + Tags */}
        <div class="flex flex-wrap items-center gap-4 text-lg text-gray-500">
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4" /><path d="M16 2v4" /><rect width="18" height="18" x="3" y="4" rx="2" /><path d="M3 10h18" /></svg>
            <time datetime={date.toISOString()}>{formattedDate}</time>
          </div>
          <span class="text-gray-300">|</span>
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>
            <span>{readingMinutes} min read</span>
          </div>
          {tags.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {tags.map((tag) => (
                <a
                  href={`/tags/${tag}`}
                  class="neo-tag bg-white px-3 py-0.5 text-sm"
                >
                  {tag}
                </a>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Table of Contents — desktop sidebar */}
      {tocItems.length > 2 && (
        <nav
          id="toc"
          class="fixed top-24 hidden max-h-[70vh] w-56 overflow-y-auto text-sm xl:block"
          style="left: max(1rem, calc((100vw - 56rem) / 2 - 15rem));"
          aria-label="Table of Contents"
        >
          <p id="toc-title" class="mb-3 text-xs font-bold uppercase tracking-widest text-gray-400">On this page</p>
          {/* English TOC */}
          <ul id="toc-en" class="space-y-1.5">
            {tocItems.map((h) => (
              <li style={h.depth === 3 ? "padding-left: 0.75rem;" : ""}>
                <a
                  href={`#${h.slug}`}
                  class="toc-link block text-gray-400 transition-colors hover:text-black"
                  data-slug={h.slug}
                >
                  {h.text}
                </a>
              </li>
            ))}
          </ul>
          {/* Chinese TOC (hidden by default) */}
          {zhTocItems.length > 0 && (
            <ul id="toc-zh" class="space-y-1.5" style="display: none;">
              {zhTocItems.map((h) => (
                <li style={h.depth === 3 ? "padding-left: 0.75rem;" : ""}>
                  <a
                    href={`#${h.slug}`}
                    class="toc-link-zh block text-gray-400 transition-colors hover:text-black"
                    data-slug={h.slug}
                  >
                    {h.text}
                  </a>
                </li>
              ))}
            </ul>
          )}
        </nav>
      )}

      {/* Article body — neo-brutalist card */}
      <div id="paper-flip" class="relative" style="perspective: 1800px;">
        {/* Back paper — subtle tilt */}
        <div
          id="paper-back"
          class="absolute inset-0 rounded-lg border-2 border-black transition-all duration-300"
          style={`transform: rotate(0.1deg); background-color: ${bilingual ? "#fffbeb" : "white"};`}
        />

        {/* Front card */}
        <div
          id="paper-card"
          class="neo-card-sm relative p-8 md:p-12"
          style="transform-origin: right center; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;"
        >
          {/* Sticker tab — top right corner */}
          {bilingual && (
            <button
              id="paper-sticker"
              class="absolute -right-3 -top-3 z-10 cursor-pointer rounded border-2 border-black bg-amber-50 px-2.5 py-1 text-xs font-bold shadow-[2px_2px_0_0_black] transition-all hover:-translate-y-0.5 hover:shadow-[3px_3px_0_0_black] active:translate-y-0 active:shadow-[1px_1px_0_0_black]"
              style="transform: rotate(3deg);"
              title="点击翻到中文"
            >
              中文
            </button>
          )}
          {bilingual ? (
            <>
              <div id="content-en" class="prose" set:html={bilingual.enHtml} />
              <div id="content-zh" class="prose" style="display: none;" set:html={bilingual.zhHtml} />
            </>
          ) : (
            <div class="prose">
              <slot />
            </div>
          )}
        </div>
      </div>

      {/* Comments section */}
      <section class="comments-section mt-12">
        <h2 class="font-architects text-2xl font-bold mb-6"
            style="transform: rotate(-1deg);">
          Leave a comment ✎
        </h2>
        <div class="neo-card-sm p-6 md:p-8">
          <script
            src="https://giscus.app/client.js"
            data-repo="adrian-mason/overtone"
            data-repo-id="R_kgDORThQUQ"
            data-category="Comments"
            data-category-id="DIC_kwDORThQUc4C2wKi"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-theme="light"
            data-lang="en"
            data-loading="lazy"
            crossorigin="anonymous"
            async>
          </script>
        </div>
      </section>

      {/* Footer — back to category */}
      <div class="flex justify-center pt-4">
        <a href={`/${category.slug}`} class="group relative">
          <div class="absolute inset-0 rounded-full border-2 border-black bg-white transition-transform group-hover:translate-x-1 group-hover:translate-y-1" />
          <div class="neo-pill relative flex items-center gap-3 px-8 py-4 text-xl font-bold">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7" /><path d="M19 12H5" /></svg>
            <span>More {category.title}</span>
          </div>
        </a>
      </div>
    </article>

    {/* Back to top button */}
    <button
      id="back-to-top"
      class="fixed bottom-8 right-8 z-50 hidden h-12 w-12 items-center justify-center rounded-full border-2 border-black bg-white shadow-[3px_3px_0_0_black] transition-all hover:-translate-y-0.5 hover:shadow-[4px_4px_0_0_black] active:translate-y-0 active:shadow-[1px_1px_0_0_black]"
      aria-label="Back to top"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6" /></svg>
    </button>
  </div>
</BaseLayout>

<style is:global>
  .prose {
    font-family: "Merriweather", serif;
    font-size: 1.0625rem;
    line-height: 1.8;
    color: #374151;
  }

  .prose :where(h2),
  .prose :where(h3) {
    position: relative;
  }

  .prose :where(h2) .heading-anchor,
  .prose :where(h3) .heading-anchor {
    position: absolute;
    left: -1.5em;
    top: 0;
    color: #d1d5db;
    text-decoration: none;
    font-weight: 400;
    opacity: 0;
    transition: opacity 0.15s ease;
  }

  .prose :where(h2):hover .heading-anchor,
  .prose :where(h3):hover .heading-anchor {
    opacity: 1;
    color: #9ca3af;
  }

  .prose :where(h2) {
    font-family: "Architects Daughter", sans-serif;
    font-weight: 700;
    font-size: 1.75rem;
    margin-top: 2em;
    margin-bottom: 0.75em;
    color: #111827;
  }

  .prose :where(h3) {
    font-family: "Architects Daughter", sans-serif;
    font-weight: 700;
    font-size: 1.375rem;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    color: #111827;
  }

  .prose :where(p) {
    margin-top: 0;
    margin-bottom: 1.25em;
  }

  .prose :where(a) {
    color: #3b82f6;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .prose :where(strong) {
    font-weight: 700;
    color: #111827;
  }

  .prose :where(ul) {
    list-style: disc;
    padding-left: 1.5em;
    margin-bottom: 1.25em;
  }

  .prose :where(ol) {
    list-style: decimal;
    padding-left: 1.5em;
    margin-bottom: 1.25em;
  }

  .prose :where(li) {
    margin-bottom: 0.375em;
  }

  .prose :where(table) {
    width: 100%;
    min-width: 500px;
    border-collapse: collapse;
    border: 2px solid black;
    border-radius: 8px;
    font-size: 0.9375rem;
    overflow: hidden;
  }

  .prose :where(thead) {
    background-color: #f9fafb;
    border-bottom: 2px solid black;
  }

  .prose :where(th) {
    padding: 0.625rem 1rem;
    text-align: left;
    font-weight: 700;
    color: #111827;
    white-space: nowrap;
  }

  .prose :where(td) {
    padding: 0.5rem 1rem;
    border-top: 1px solid #e5e7eb;
  }

  .prose :where(tbody tr:hover) {
    background-color: #f9fafb;
  }

  .prose :where(blockquote) {
    border-left: 3px solid black;
    padding-left: 1em;
    font-style: italic;
    color: #6b7280;
    margin-top: 1.25em;
    margin-bottom: 1.25em;
  }

  .prose :where(code) {
    font-size: 0.875em;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    background-color: #f3f4f6;
    padding: 0.125em 0.375em;
    border-radius: 0.25rem;
    border: 1px solid #e5e7eb;
    color: #1f2937;
  }

  .prose :where(pre) {
    background-color: #f9fafb;
    border: 2px solid black;
    border-radius: 8px;
    padding: 1rem 1.25rem;
    overflow-x: auto;
    margin-top: 1.25em;
    margin-bottom: 1.25em;
  }

  .prose :where(pre code) {
    background-color: transparent;
    padding: 0;
    border-radius: 0;
    border: none;
    font-size: 0.8125rem;
    line-height: 1.7;
  }

  .prose :where(hr) {
    border-color: black;
    border-style: dashed;
    margin-top: 2em;
    margin-bottom: 2em;
  }

  .prose :where(img) {
    border: 2px solid black;
    border-radius: 8px;
    margin-top: 1.25em;
    margin-bottom: 1.25em;
  }
</style>

<script>
  // Mermaid diagram rendering — render EN blocks first, then clone SVGs to ZH
  const enMermaid = document.querySelectorAll("#content-en pre.mermaid");
  const zhMermaid = document.querySelectorAll("#content-zh pre.mermaid");
  const allMermaid = document.querySelectorAll("pre.mermaid");
  if (allMermaid.length > 0) {
    // Decode HTML entities (e.g. &gt; → >) but preserve <br/> tags for mermaid line breaks
    allMermaid.forEach((pre) => {
      pre.innerHTML = pre.innerHTML
        .replace(/&gt;/g, ">")
        .replace(/&lt;/g, "<")
        .replace(/&amp;/g, "&");
    });
    const script = document.createElement("script");
    script.src = "https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js";
    script.onload = () => {
      (window as any).mermaid.initialize({ startOnLoad: false, theme: "neutral" });
      const toRender = enMermaid.length > 0 ? enMermaid : allMermaid;
      (window as any).mermaid.run({ nodes: toRender }).then(() => {
        // Clone rendered EN SVGs into ZH blocks (same content, avoids hidden-element issue)
        if (enMermaid.length > 0 && zhMermaid.length === enMermaid.length) {
          zhMermaid.forEach((zhPre, i) => {
            zhPre.innerHTML = enMermaid[i].innerHTML;
          });
        }
      });
    };
    document.head.appendChild(script);
  }

  // Wrap tables in scrollable containers for mobile
  document.querySelectorAll(".prose table").forEach((table) => {
    const wrapper = document.createElement("div");
    wrapper.style.overflowX = "auto";
    wrapper.style.marginTop = "1.25em";
    wrapper.style.marginBottom = "1.25em";
    wrapper.style.webkitOverflowScrolling = "touch";
    table.parentNode!.insertBefore(wrapper, table);
    wrapper.appendChild(table);
  });

  const bar = document.getElementById("reading-progress");
  const topBtn = document.getElementById("back-to-top");

  window.addEventListener("scroll", () => {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;

    // Progress bar
    if (bar) {
      const progress = docHeight > 0 ? Math.min(scrollTop / docHeight, 1) : 0;
      bar.style.transform = `scaleX(${progress})`;
    }

    // Back to top visibility
    if (topBtn) {
      topBtn.style.display = scrollTop > window.innerHeight ? "flex" : "none";
    }
  }, { passive: true });

  topBtn?.addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // TOC active section tracking
  const tocLinks = document.querySelectorAll<HTMLAnchorElement>(".toc-link");
  if (tocLinks.length > 0) {
    const headings = Array.from(tocLinks).map((link) =>
      document.getElementById(link.dataset.slug ?? "")
    ).filter(Boolean) as HTMLElement[];

    const observer = new IntersectionObserver(
      (entries) => {
        for (const entry of entries) {
          const link = document.querySelector(`.toc-link[data-slug="${entry.target.id}"]`);
          if (!link) continue;
          if (entry.isIntersecting) {
            tocLinks.forEach((l) => { l.style.color = ""; l.style.fontWeight = ""; });
            link.setAttribute("style", "color: #111827; font-weight: 700;");
          }
        }
      },
      { rootMargin: "-80px 0px -70% 0px" }
    );

    headings.forEach((h) => observer.observe(h));
  }

  // Bilingual paper flip
  const contentEn = document.getElementById("content-en");
  const contentZh = document.getElementById("content-zh");
  const paperCard = document.getElementById("paper-card");
  const paperBack = document.getElementById("paper-back");
  const paperSticker = document.getElementById("paper-sticker");
  const paperFlip = document.getElementById("paper-flip");
  const tocEn = document.getElementById("toc-en");
  const tocZh = document.getElementById("toc-zh");
  const tocTitle = document.getElementById("toc-title");

  const setGiscusLang = (lang: string) => {
    const iframe = document.querySelector<HTMLIFrameElement>("iframe.giscus-frame");
    if (iframe?.contentWindow) {
      iframe.contentWindow.postMessage(
        { giscus: { setConfig: { lang } } },
        "https://giscus.app"
      );
    }
  };

  if (paperSticker && contentEn && contentZh && paperCard && paperBack) {
    let currentLang = "en";
    let isAnimating = false;

    const doFlip = () => {
      if (isAnimating) return;
      isAnimating = true;

      // Page turn — lift and rotate from right edge
      paperCard.style.transform = "rotateY(-80deg) scale(0.95)";
      paperCard.style.opacity = "0.3";

      setTimeout(() => {
        if (currentLang === "en") {
          contentEn.style.display = "none";
          contentZh.style.display = "block";
          paperBack.style.backgroundColor = "white";
          paperBack.style.transform = "rotate(-0.2deg)";
          paperCard.style.backgroundColor = "#fffbeb";
          paperCard.style.borderColor = "#fbbf24";
          paperSticker.textContent = "EN";
          paperSticker.style.backgroundColor = "white";
          paperSticker.title = "Switch to English";
          if (tocEn) tocEn.style.display = "none";
          if (tocZh) tocZh.style.display = "";
          if (tocTitle) tocTitle.textContent = "本页目录";
          setGiscusLang("zh-CN");
          currentLang = "zh";
        } else {
          contentZh.style.display = "none";
          contentEn.style.display = "block";
          paperBack.style.backgroundColor = "#fffbeb";
          paperBack.style.transform = "rotate(0.1deg)";
          paperCard.style.backgroundColor = "";
          paperCard.style.borderColor = "";
          paperSticker.textContent = "中文";
          paperSticker.style.backgroundColor = "#fffbeb";
          paperSticker.title = "点击翻到中文";
          if (tocZh) tocZh.style.display = "none";
          if (tocEn) tocEn.style.display = "";
          if (tocTitle) tocTitle.textContent = "On this page";
          setGiscusLang("en");
          currentLang = "en";
        }

        // Page turn back
        paperCard.style.transform = "rotateY(0deg) scale(1)";
        paperCard.style.opacity = "1";

        // Scroll to card top
        if (paperFlip) {
          const rect = paperFlip.getBoundingClientRect();
          if (rect.top < 0) {
            paperFlip.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        }

        setTimeout(() => { isAnimating = false; }, 500);
      }, 450);
    };

    paperSticker.addEventListener("click", doFlip);
  }

  // Heading anchor links
  document.querySelectorAll(".prose h2[id], .prose h3[id]").forEach((heading) => {
    const anchor = document.createElement("a");
    anchor.href = `#${heading.id}`;
    anchor.className = "heading-anchor";
    anchor.setAttribute("aria-hidden", "true");
    anchor.textContent = "#";
    heading.prepend(anchor);
  });
</script>
